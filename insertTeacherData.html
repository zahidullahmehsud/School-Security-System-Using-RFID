<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Registration</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <link rel="stylesheet" href="phpcode/styles2.css">
    <link rel="stylesheet" href="Dashboard.css">
    <link rel="stylesheet" href="./styles/Dashboard.css">
    <link rel="stylesheet" href="./styles/sidebar.css">
</head>

<body>
    <div class="sidebar">

        <ul class="nav-links">
            <li>
                <a href="Dashboard.html" class="active">
                    <i class="bx bx-grid-alt"></i>
                    <span class="link_name">Dashboard</span>
                </a>

            </li>
            <li>
                <div class="iocn-link">
                    <a href="">
                        <i class="fa fa-users" aria-hidden="true"></i>
                        <span class="link_name">Teacher Management</span>
                    </a>
                    <i class='bx bxs-chevron-down arrow'></i>
                </div>
                <ul class="sub-menu">
                    <li><a class="link_name" href="#">Category</a></li>
                    <li><a href="insertTeacherData.html">Teacher Registration</a></li>
                    <li><a href="teacherRecord.html">Teachers Record</a></li>
                    <li><a href="Attendance.html">Attendance</a></li>
                    <li><a href="ManuallyAttendanceMarkStd.html">Manual Attenedance</a></li>
                    <li><a href="LeaveRequests.html">Leave Requests</a></li>
                    <li><a href="TeacherCardRequest.html">Card Requests</a></li>
                </ul>
            </li>
            <li>
                <div class="iocn-link">
                    <a href="#">
                        <i class="fa fa-graduation-cap" aria-hidden="true"></i>
                        <span class="link_name">Student Management</span>
                    </a>
                    <i class='bx bxs-chevron-down arrow'></i>
                </div>
                <ul class="sub-menu">

                    <li><a href="InsertStdData.html">Student Registration</a></li>
                    <li><a href="StudentRecord.html">Students Record</a></li>
                    <li><a href="StudentNewCardRequests.html">Card Requests</a></li>
                </ul>
            </li>

            <li>
                <a href="securityOfficer.html">
                    <i class="fas fa-shield"></i>
                    <span class="link_name">Security Officer</span>
                </a>

            </li>
            <li>
                <a href="setSchoolTiming.html">
                    <i class="fas fa-clock"></i>
                    <span class="link_name">Set School Timing</span>
                </a>
            </li>
            <li>
                <a href="map.html">
                    <i class="fas fa-map-marker-alt"></i>
                    <span class="link_name">Select School Area</span>
                </a>
            </li>
            <li>
        </ul>
        <a href="index.html">
            <div class="profile-details">
                <div class="profile-content">
                    <img src="website_log.png" alt="profileImg">
                </div>
                <div class="name-job">
                    <div class="profile_name">Admin</div>
                    <div class="job">Log out</div>
                </div>
                <i class='bx bx-log-out' style="color: #fff; font-size: 30px;"></i>
            </div>
        </a>

    </div>
    <section class="home-section">
        <nav>
            <div class="profile-details" style="width: 100px;  ">
                <span class="admin_name">Teacher Registration <i class="fa fa-users" aria-hidden="true"></i></span>
            </div>
            <div class="logo-details">


                <img src="website_log.png" alt="Website Logo" style="width: 50px; display: block; margin: 0 auto; ">

                <div>
                    <span style="display: block; text-align: center; color:black; font-weight: bold;">School Security
                        System</span>

                </div>


            </div>
            <div class="profile-details">

                <span class="admin_name">Admin Pannel <i class="fa fa-user-circle"></i>
                </span>
            </div>

        </nav>
        <div class="home-content">
            <script src="inputValidationTeac.js"> </script>
            <!-- ////////////////// -->
            <div class="tick" id="tick">
                <div class="tick-mark">&#10004;</div>
                <p style="display: contents;" class="success-message">Card Scanned Successfully</p>
            </div>
            <div class="overlay" id="overlay"></div>
            <div class="popup" id="popup">
                <button class="close-button" id="closePopup">&times;</button>
                <div class="card">
                    <div class="scan-line"></div>
                    <div class="card-details">
                        <h1>Card Scanning</h1>
                        <p style="display: contents;">Place your card on the scanner</p>
                    </div>
                </div>
            </div>
            <!-- ////////////////////////// -->
            <br>

            <div class="enterdetailheader">
                <h1 style="text-align: center;">Enter Teacher details</h1>
                <div id="form-container">


                    <div class="form-group">
                        <!-- <span> <label for="enterID">ID: </label></span> -->
                        <p id="enterID" style="
       border-radius: 10px;
            font-size: 16px;
            background: linear-gradient(to right, #ff9900, #ff5722);
            color: white;
            text-align: center;
           
            width: 600px;
            height: 27px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            margin-left:50px;
            border: 2px solid #ff5722;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.3);">ID</p>

          

                    
                    </div>
                    <p id="errorID" class="error-message" style="color: red; font-weight: bold; align-items: center;
                    justify-content: center;"></p>
                    
                    <div class="form-group" style="padding-left: 270px;"><button id="openPopup">Get Card UID <i
                                class="fa fa-id-card-o" aria-hidden="true"></i></button></div>

                    <div class="form-group">
                        <label for="enterFirstName">First Name</label>
                        <input type="text" id="enterFirstName" oninput="validateInput('enterFirstName')">
                        <p id="enterFirstName-error" style="color: red;"></p>
                    </div>

                    <div class="form-group">
                        <label for="enterLastName">Last Name</label>
                        <input type="text" id="enterLastName" oninput="validateInput('enterLastName')">
                        <p id="enterLastName-error" style="color: red;"></p>
                    </div>
                    <div class="form-group" style="display: none;">

                        <div class="radio-group">
                            <label for="classTeacher" style="padding-left: 10px;">Want to make him a class
                                teacher:</label>
                            <input type="radio" id="yes" name="classTeacher" value="yes" onclick="toggleClassList(this)"
                                checked>
                            <label for="yes">Yes</label>

                            <input type="radio" id="no" name="classTeacher" value="no" onclick="toggleClassList(this)">
                            <label for="no">No</label>
                        </div>
                    </div>

                    <div class="form-group" style="padding-left:108px" id="classList" style="display: none;">

                        <select id="enterClass" onchange="validateInput('enterClass')">
                            <option value="">Select Class</option>
                            <option value="1">Class 1</option>
                            <option value="2">Class 2</option>
                            <option value="3">Class 3</option>
                            <option value="4">Class 4</option>
                            <option value="5">Class 5</option>
                            <option value="6">Class 6</option>
                            <option value="7">Class 7</option>
                            <option value="8">Class 8</option>
                            <option value="9">Class 9</option>
                            <option value="10">Class 10</option>
                        </select>
                        <p id="enterClass-error" style="color: red;"></p>
                    </div>
                    <div class="createaccount">
                        <h1>Create Account</h1>
                        <div class="form-group">
                            <label for="enterEmail">Email</label>
                            <input type="text" id="enterEmail" oninput="validateInput('enterEmail')">
                            <p id="enterEmail-error" style="color: red;"></p>
                        </div>
                        <div class="form-group">
                            <label for="enterPassword">Password</label>
                            <input type="password" id="enterPassword" style="height: 30px;width: 40%;" />
                            <p id="enterPassword-error" style="color: red;"></p>
                        </div>
                    </div>
                    <button id="submit-button" class="insertTec-button-Style" disabled>INSERT</button>
                </div>
            </div>
        </div>
    
        <Style>
            .nav-dropdown-btn.active+.nav-dropdown-content {
                background-color: #0A2558;
              
                transition: background-color 0.3s ease;
              
            }
        </Style>
        <script>
            function toggleClassList(radioButton) {
                const classList = document.getElementById('classList');
                if (radioButton.value === 'yes') {
                    classList.style.display = 'block';
                } else {
                    classList.style.display = 'none';
                }
            }
        </script>
        <script type="module" src="phpcode/script2.js"> </script>
        <script src="./scripts/sidebar.js"></script>
  
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
            import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-analytics.js";
            import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
            const firebaseConfig = {
                apiKey: "AIzaSyDCXvbE44rMmYlkSLMIsramC6tiBcLBNH4",
                authDomain: "schoolsecuritysystemusin-4c8fa.firebaseapp.com",
                databaseURL: "https://schoolsecuritysystemusin-4c8fa-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "schoolsecuritysystemusin-4c8fa",
                storageBucket: "schoolsecuritysystemusin-4c8fa.appspot.com",
                messagingSenderId: "58102931592",
                appId: "1:58102931592:web:8b2a5aee4664b3df023f3d",
                measurementId: "G-KTK6CHM7EF"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            import { getDatabase, ref, get, set, remove } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";
            const db = getDatabase();
            const auth = getAuth(app);

            const enterID = document.querySelector("#enterID");
            const enterFirstName = document.querySelector("#enterFirstName");
            const enterLastName = document.querySelector("#enterLastName");
            const enterEmail = document.querySelector("#enterEmail");
            const insertBtn = document.querySelector("#submit-button");
            const enterClass = document.querySelector("#enterClass");
            const yesRadio = document.querySelector("#yes");
            const noRadio = document.querySelector("#no");
            const enterPassword = document.querySelector("#enterPassword");  
            
            var userUid;
            ////////////////////////////////////////////////////////////////////////////////////////
            function createAccount() {

                var email = enterEmail.value;
                var password = enterPassword.value;
                const selectedClass = enterClass.value;

                checkExistingEmail(email)
                    .then((emailExists) => {
                        if (emailExists) {

                            document.getElementById("enterEmail-error").textContent = "Email already exists. Please try another one.";
                        } else {
                            checkClassTeacher(selectedClass)
                                .then((classTeacherExists) => {
                                    if (classTeacherExists) {

                                        document.getElementById("enterClass-error").textContent = "A class teacher is already assigned for this class.";
                                    } else {

                                        createUserWithEmailAndPassword(auth, email, password)
                                            .then((userCredential) => {


                                                const user = userCredential.user;
                                                userUid = user.uid;
                                                sendEmailVerification(auth.currentUser)
                                                    .then(() => {
                                                        console.log("verifying");
                                                        AddTeacherRecord();


                                                    });




                                            })
                                            .catch((error) => {
                                                const errorCode = error.code;
                                                const errorMessage = error.message;
                                                if (errorCode === 'auth/email-already-in-use') {
                                                    alert('Email is already in use. Please try another one');
                                                }

                                                if (errorCode === 'auth/weak-password') {
                                                    alert('Password must be at least 6 characters long');
                                                }

                                                if (errorCode === 'auth/invalid-email') {
                                                    alert('Invalid Email');
                                                }

                                                if (errorCode === 'auth/missing-email') {
                                                    alert('Missing email');
                                                }
                                                if (errorCode === 'auth/internal-error') {
                                                    alert('Password missing');
                                                }

                                            });
                                    }
                                })
                        }
                    })
            }
            //////////////////////////////////////////////////////////////////////////////////////////////////
            function AddTeacherRecord() {
                const id = parseInt(enterID.textContent);
                const firName = enterFirstName.value;
                const lasName = enterLastName.value;
                const email = enterEmail.value;
                var password = enterPassword.value;

                if (yesRadio.checked) {
                    var classValue = yesRadio.value;
                } else if (noRadio.checked) {
                    var classValue = noRadio.value;
                }

                const classStatus = classValue;
                const selectedClass = enterClass.value;

                checkExistingEmail(email)
                    .then((emailExists) => {
                        if (emailExists) {

                            document.getElementById("enterEmail-error").textContent = "Email already exists. Please try another one.";
                        } else {

                            document.getElementById("enterEmail-error").textContent = "";


                            checkClassTeacher(selectedClass)
                                .then((classTeacherExists) => {
                                    if (classTeacherExists) {

                                        document.getElementById("enterClass-error").textContent = "A class teacher is already assigned for this class.";
                                    } else {

                                        document.getElementById("enterClass-error").textContent = "";


                                        set(ref(db, "TeacherData/" + id), {
                                            firstname: firName,
                                            lastname: lasName,
                                            ID: id,
                                            Email: email,
                                            classTeacher: classStatus,
                                            class: selectedClass,
                                            password: password,
                                            uid: userUid
                                        })
                                            .then(() => {
                                                alert("Teacher registered successfully");



                                                set(ref(db, "allowed-card-ids/" + id), "allowed")
                                                    .then(() => {
                                                        console.log("Data written successfully!");
                                                    })
                                                    .catch((error) => {
                                                        console.error("Error writing data: ", error);
                                                    });

                                                if (classStatus === 'yes') {

                                                    set(ref(db, "ClassRoom/" + selectedClass + "/ClassTeacher/" + id), {
                                                        ID: id,
                                                        firstName: firName,
                                                        lastName: lasName,
                                                        Email: email,
                                                        password: password,
                                                    })
                                                        .then(() => {
                                                            console.log("Data written successfully!");
                                                            enterID.textContent = "ID";
                                                            enterFirstName.value = "";
                                                            enterLastName.value = "";
                                                            enterEmail.value = "";
                                                            enterClass.value = "";
                                                            enterPassword.value = "";
                                                        })
                                                        .catch((error) => {
                                                            console.error("Error writing data: ", error);
                                                        });
                                                } else {
                                                    enterID.textContent = "ID";
                                                    enterFirstName.value = "";
                                                    enterLastName.value = "";
                                                    enterEmail.value = "";
                                                    enterClass.value = "";
                                                    enterPassword.value = "";
                                                }
                                            })
                                            .catch((error) => {
                                                alert(error);
                                            });
                                    }
                                })
                                .catch((error) => {
                                    alert(error);
                                });
                        }
                    })
                    .catch((error) => {
                        alert(error);
                    });
            }
            /////////////////////////////////////////////////////////////////////////////////////////////////////////
            function InsertData() {
                const classTeacherRadio = document.querySelector("#yes");
                const selectedClass = document.querySelector("#enterClass").value;
                const id = enterID.textContent;
                
                if (id == 'ID') {
                    document.getElementById("errorID").innerHTML = "*** Please Scan RFID Card First";
                    

                }
                else {

                    if (classTeacherRadio.checked && selectedClass === "") {

                        document.getElementById("enterClass-error").textContent = "Please select a class for the class teacher.";
                    } else {

                        document.getElementById("enterClass-error").textContent = "";
                        createAccount();
                    }
                }

            }
            ////////////////////////////////////////////////////////////////////////////////////////////////////////            
            function checkExistingEmail(email) {

                const emailRef = ref(db, "TeacherData");
                return get(emailRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const teachers = snapshot.val();
                        return Object.values(teachers).some((teacher) => teacher.Email === email);
                    }
                    return false;
                });
            }
            ////////////////////////////////////////////////////////////////////////////////////////////////////////
            function checkClassTeacher(selectedClass) {

                const classTeacherRef = ref(db, "ClassRoom/" + selectedClass + "/ClassTeacher");
                return get(classTeacherRef).then((snapshot) => {
                    return snapshot.exists();
                });
            }

           
            insertBtn.addEventListener('click', InsertData);

        </script>
</body>

</html>